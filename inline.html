<html>
  <head>
    <meta charset="utf-8" />
    <title>easypay Checkout Demo</title>
    <!-- include from CDN -->
    <script src="https://cdn.easypay.pt/checkout/2.2.0/"></script>
  </head>
  <body>
    <div id="easypay-checkout"></div>
    <script>
      /** Used to store the checkout instance and later unmount it. */
      let checkoutInstance
      let manifest

      /** The code we want to run when Checkout finishes successfully. */
      function onCheckoutClose() {
        checkoutInstance.unmount()
        document.write('Your order was received. Thank you.')
      }

      /** The code we want to run on Checkout errors. */
      function onCheckoutError(error) {
        checkoutInstance.unmount()
        switch (error.code) {
          case 'checkout-expired':
            getCheckoutManifest()
            break
          case 'already-paid':
            document.write('Your order was already paid. Thank you.')
            break
          case 'checkout-canceled':
            document.write('Your order was canceled.')
            break
          default:
            document.write('Unable to process payment, please try again.')
        }
      }

      /**
       * Call the Checkout SDK with manifest and options.
       * In this case, we are using the default id 'easypay-checkout' and passing an 'onClose' handler.
       */
      function initEasypayCheckoutSDK(manifest) {
        checkoutInstance = easypayCheckout.startCheckout(manifest, {
          onClose: onCheckoutClose,
          onError: onCheckoutError,
          language: 'en',
          hideDetails: sessionStorage.getItem('hideDetails') === 'true' ? true : false,
          logoUrl: sessionStorage.getItem("logoUrl") === 'true' ? 'https://easypay-cdn-delivery.s3.eu-central-1.amazonaws.com/emails/easypay_logo.svg' : '',
          testing: true
        })
      }

      /**
       * Gets a Checkout Manifest by using the server-side APIs
       * and initializes the easypay Checkout SDK with it.
       * @see app.js for the server-side request.
       */
      function getCheckoutManifest() {
        const req = new XMLHttpRequest()
        req.onreadystatechange = (e) => {
          if (req.readyState === XMLHttpRequest.DONE) {
            if (req.status === 200) {
              manifest = JSON.parse(req.responseText)
              initEasypayCheckoutSDK(manifest)
            } else {
              console.error(`Error ${req.status} ${req.statusText}`, req.responseText)
            }
          }
        }
        const url =
          sessionStorage.getItem('subscription') === 'true'
            ? '/checkoutmanifest/subscription'
            : '/checkoutmanifest/single'
        req.open('GET', url)
        req.send()
      }

      getCheckoutManifest()
    </script>
  </body>
</html>
